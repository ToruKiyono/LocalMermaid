# LocalMermaid

ä¸€ä¸ªå¯ä»¥åœ¨å®Œå…¨ç¦»çº¿ç¯å¢ƒä¸‹ä½¿ç”¨çš„ Mermaid æ¸²æŸ“å·¥ä½œå°ï¼Œå†…ç½®å¸¸ç”¨å›¾è¡¨ç¤ºä¾‹ï¼Œæ”¯æŒæœ¬åœ°ç¼–è¾‘ã€å®æ—¶æ¸²æŸ“ã€é”™è¯¯æç¤ºä¸å¤šç‰ˆæœ¬åˆ‡æ¢ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **å¼€ç®±å³ç”¨**ï¼šä»“åº“è‡ªå¸¦ `public/vendor/mermaid.min.js`ï¼ˆå½“å‰ä¸º v11.12.1ï¼‰ä¸ç‰ˆæœ¬æ¸…å•ï¼Œå®Œå…¨ç¦»çº¿å³å¯æ¸²æŸ“ã€‚
- ğŸ” **å¤šç‰ˆæœ¬åˆ‡æ¢**ï¼šè¯»å– `mermaid-meta.json` ä¸­çš„ç‰ˆæœ¬åˆ—è¡¨ï¼Œå‰ç«¯å¯å³æ—¶åˆ‡æ¢ Mermaid å†…æ ¸å¹¶åˆ·æ–°å½“å‰å›¾è¡¨ã€‚
- ğŸ› ï¸ **ç¼–è¾‘ä½“éªŒ**ï¼šæä¾›è¯­æ³•é«˜äº®ã€è¡Œå·/è¡Œæ•°ç»Ÿè®¡ã€å®æ—¶å…‰æ ‡è¡Œåˆ—å®šä½ã€å¿«æ·æ¸²æŸ“ï¼ˆCtrl/âŒ˜ + Enterï¼‰ã€æ›´å®½å¹¿çš„ç¼–è¾‘é¢æ¿ä»¥åŠç¤ºä¾‹åº“ä¸€é”®è½½å…¥ã€‚
- ğŸ–±ï¸ **é¢„è§ˆå¢å¼º**ï¼šæ¸²æŸ“ç»“æœé¢æ¿æ”¯æŒç¼©æ”¾ã€å¹³ç§»ã€å±…ä¸­å¤ä½ï¼Œå¹¶å¯å¤åˆ¶ PNGã€å¯¼å‡º SVG/PNGã€‚
- ğŸ” **è¯­æ³•æ ¡éªŒ**ï¼šæ¸²æŸ“å‰è‡ªåŠ¨è°ƒç”¨ `mermaid.parse`ï¼Œç¬¬ä¸€æ—¶é—´æš´éœ²è¯­æ³•é”™è¯¯å¹¶æç¤ºå®šä½ã€‚
- ğŸ¨ **ç¤ºä¾‹å›¾åº“**ï¼šæ¶µç›–æµç¨‹ã€æ—¶åºã€çŠ¶æ€ã€æ—…ç¨‹ã€ç”˜ç‰¹ã€ç±»å›¾ã€ERã€Git Graphã€é¥¼å›¾ã€æŠ˜çº¿/æŸ±çŠ¶/XY å›¾ã€æ€ç»´å¯¼å›¾ã€æ—¶é—´çº¿ã€éœ€æ±‚å›¾ã€è±¡é™å›¾ã€C4ã€æ¡‘åŸºå›¾ç­‰ 16+ å½©è‰²æ¡ˆä¾‹ã€‚

## æœ¬æ¬¡æ›´æ–°äº®ç‚¹

- ğŸ“ æ‰©å¤§ç¼–è¾‘åŒºä¸é¢„è§ˆåŒºå°ºå¯¸ï¼Œé•¿å›¾ç¼–å†™æ—¶ä¸å†æ‹¥æŒ¤ï¼ŒåŒæ—¶ä¿®å¤è¯­æ³•é«˜äº®é®æŒ¡å¯¼è‡´çš„ã€Œè¡Œæ•°å¤šæ—¶çœ‹ä¸åˆ°å°¾éƒ¨ä»£ç ã€é—®é¢˜ã€‚
- ğŸ§­ æ–°å¢å…‰æ ‡è¡Œåˆ—å±•ç¤ºä¸æ»šåŠ¨åŒæ­¥é€»è¾‘ï¼Œé•¿æ–‡æ¡£ç¼–è¾‘æ—¶èƒ½å¤Ÿè¿…é€Ÿå®šä½å½“å‰æ‰€åœ¨ä½ç½®ã€‚
- ğŸ—‚ï¸ æ‰©å±•ç¤ºä¾‹åº“ï¼Œè¦†ç›–ç”¨æˆ·åé¦ˆä¸­æåˆ°çš„æµç¨‹ã€æ—…ç¨‹ã€C4ã€æ¡‘åŸºã€XY/æŠ˜çº¿/æŸ±çŠ¶ç­‰ 16 ç±»å…¸å‹å›¾è¡¨å¹¶ä½¿ç”¨é†’ç›®é…è‰²ã€‚

## ä½¿ç”¨æŒ‡å—

1. **ç«‹å³å¯ç”¨çš„ç¦»çº¿åŒ…**

   > ä»“åº“å·²ç»å†…ç½® Mermaid v11.12.1 çš„æ„å»ºæ–‡ä»¶ä¸é™æ€èµ„æºï¼Œæ— éœ€æ‰§è¡Œä»»ä½•å®‰è£…å‘½ä»¤å³å¯ç›´æ¥æ‰“å¼€ `public/index.html` ä½¿ç”¨ã€‚

   ```bash
   npm install
   ```

   > å¯é€‰ï¼šå¦‚éœ€éªŒè¯ Node.js ä¸ NPM æ˜¯å¦å¯ç”¨ï¼Œå¯è¿è¡Œ `npm install`ã€‚é¡¹ç›®ä¸å†ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…ï¼Œè¯¥å‘½ä»¤ä¼šç¬é—´å®Œæˆä¸”ä¸ä¼šè®¿é—®å¤–ç½‘ã€‚

  - **éœ€è¦å‡çº§ Mermaid ç‰ˆæœ¬æ—¶**ï¼šè¿è¡Œ `npm run fetch:mermaid`ã€‚è„šæœ¬ä¼šå…ˆå°è¯•ä» GitHub Releaseï¼ˆ`https://github.com/mermaid-js/mermaid/releases/download/vX.Y.Z/mermaid.min.js`ï¼‰ä¸‹è½½ï¼Œè‹¥è¯¥ç‰ˆæœ¬æœªæä¾›æ„å»ºäº§ç‰©ï¼Œåˆ™è‡ªåŠ¨å›é€€åˆ° jsDelivr / unpkg CDNï¼Œå¹¶åœ¨ `public/vendor/mermaid-meta.json` çš„ `packages` åˆ—è¡¨ä¸­æ›´æ–°é»˜è®¤æ¡ç›®ã€‚
  - **æ–°å¢æˆ–æ›¿æ¢æœ¬åœ°ç‰ˆæœ¬**ï¼šå¯æ‰‹åŠ¨ä¸‹è½½ `mermaid.min.js` åˆ° `public/vendor/` ä»»æ„å­ç›®å½•ï¼Œå¹¶åœ¨ `mermaid-meta.json` ä¸­è¿½åŠ ä¸€ä¸ªæ¡ç›®ï¼š

    ```json
    {
      "id": "mermaid-11-1-0",
      "label": "Mermaid v11.1.0ï¼ˆæ‰‹åŠ¨å¯¼å…¥ï¼‰",
      "version": "11.1.0",
      "scriptPath": "vendor/mermaid-11.1.0/mermaid.min.js",
      "source": "GitHub Releases",
      "downloadUrl": "https://github.com/mermaid-js/mermaid/releases/download/v11.1.0/mermaid.min.js",
      "downloadedAt": "2025-02-18T09:00:00.000Z"
    }
    ```

    ä¿å­˜ååˆ·æ–°é¡µé¢å³å¯åœ¨ã€ŒMermaid ç‰ˆæœ¬ã€ä¸‹æ‹‰æ¡†ä¸­çœ‹åˆ°æ–°é€‰é¡¹ã€‚

     ```bash
     # GitHub Releaseï¼ˆè‹¥è¯¥ç‰ˆæœ¬æä¾›ï¼‰
     curl -L "https://github.com/mermaid-js/mermaid/releases/download/v11.12.1/mermaid.min.js" -o public/vendor/mermaid.min.js

     # CDN å¤‡é€‰
     curl -L "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js" -o public/vendor/mermaid.min.js
     ```

   > ä¸‹è½½è„šæœ¬ä¼šè‡ªåŠ¨è¯»å– `HTTPS_PROXY` / `HTTP_PROXY` ç¯å¢ƒå˜é‡ï¼ˆç›®å‰æ”¯æŒ `http://` ä»£ç†ï¼‰ã€‚å¦‚éœ€åœ¨éœ€è¦ä»£ç†çš„ç½‘ç»œä¸­æ‰§è¡Œï¼Œå¯åœ¨è¿è¡Œå‘½ä»¤å‰è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ `export HTTPS_PROXY="http://127.0.0.1:7890"`ï¼‰ã€‚

2. **å¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰**

   ```bash
   npm run start
   ```

   è®¿é—®ç»ˆç«¯è¾“å‡ºçš„åœ°å€ï¼ˆé»˜è®¤ `http://localhost:4173` å³å¯åŠ è½½ä¸»é¡µï¼‰ï¼Œæˆ–ç›´æ¥ä½¿ç”¨æ–‡ä»¶åè®®æ‰“å¼€ `public/index.html`ã€‚

3. **å¼€å§‹ç»˜åˆ¶**

   - åœ¨å·¦ä¾§ç¼–è¾‘å™¨è¾“å…¥ Mermaid ä»£ç ï¼Œç‚¹å‡»â€œæ¸²æŸ“â€æˆ–ä½¿ç”¨ `Ctrl/âŒ˜ + Enter` å¿«æ·é”®ã€‚
   - å¦‚æœ‰è¯­æ³•é—®é¢˜ï¼Œé”™è¯¯ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨é¢„è§ˆåŒºåŸŸé¡¶éƒ¨ã€‚
   - æ”¯æŒè¯­æ³•é«˜äº®ã€è¡Œå·/è¡Œæ•°ç»Ÿè®¡ã€å…‰æ ‡è¡Œåˆ—æç¤ºã€ä¸€é”®å¤åˆ¶ä»£ç ã€å¤åˆ¶ PNGã€å¯¼å‡º SVG/PNGã€ç‰ˆæœ¬åˆ‡æ¢ï¼Œä»¥åŠæµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢ã€‚
   - é¢„è§ˆé¢æ¿å†…ç½®ç¼©æ”¾ã€å¹³ç§»ä¸é‡ç½®è§†å›¾æ§åˆ¶ï¼Œå¸®åŠ©åœ¨å¤§å›¾åœºæ™¯ä¸‹æŸ¥çœ‹ç»†èŠ‚ã€‚

## å†…ç½®ç¤ºä¾‹ä¸€è§ˆ

| å›¾è¡¨ç±»å‹ | ç¤ºä¾‹åç§° |
| --- | --- |
| ğŸ§­ æµç¨‹ç±» | å…¨é“¾è·¯å¢é•¿å®éªŒ |
| ğŸ” æ—¶åºå›¾ | å®æ—¶å¹³å°å›æµ |
| ğŸ§± çŠ¶æ€å›¾ | å˜æ›´å®¡æ‰¹æµ |
| ğŸ”„ ç”¨æˆ·æ—…ç¨‹ | ä½“éªŒæ—…ç¨‹ |
| ğŸ§¬ ç”˜ç‰¹å›¾ | è¿­ä»£è§„åˆ’ |
| ğŸ§© ç±»å›¾ | é¢†åŸŸå»ºæ¨¡ |
| ğŸ•¸ï¸ ER å›¾ | ç”µå•†æ¨¡å‹ |
| ğŸ”— Git Graph | ç‰ˆæœ¬å‘å¸ƒ |
| ğŸŒ é¥¼å›¾ | æ¸ é“æ„æˆ |
| ğŸ“ˆ æŠ˜çº¿å›¾ | æ´»è·ƒè¶‹åŠ¿ |
| ğŸ“Š æŸ±çŠ¶å›¾ | æ¸ é“è½¬åŒ–ç‡ |
| ğŸ“ˆ XY å›¾ | è½¬åŒ– vs ç•™å­˜ |
| ğŸ§  æ€ç»´å¯¼å›¾ | é¡¹ç›®è§„åˆ’ |
| ğŸ—‚ï¸ æ—¶é—´çº¿ | å‘å¸ƒè®¡åˆ’ |
| ğŸ”„ Requirement | éœ€æ±‚è¿½è¸ª |
| ğŸ§­ è±¡é™å›¾ | ä¼˜å…ˆçº§çŸ©é˜µ |
| âš™ï¸ C4 | ç³»ç»Ÿå®¹å™¨è§†å›¾ |
| ğŸ“Š Sankey | æ¼æ–—æµå‘ |

## é¡¹ç›®ç»“æ„

```
LocalMermaid/
â”œâ”€â”€ package.json                # NPM è„šæœ¬ä¸é¡¹ç›®å…ƒæ•°æ®
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”œâ”€â”€ app.js             # å‰ç«¯é€»è¾‘ä¸æ¸²æŸ“æ§åˆ¶
â”‚   â”‚   â””â”€â”€ styles.css         # é¡µé¢æ ·å¼
â”‚   â”œâ”€â”€ index.html             # é¡µé¢å…¥å£
â”‚   â””â”€â”€ vendor/                # å­˜æ”¾ç¦»çº¿çš„ mermaid å‘è¡Œæ–‡ä»¶
â”‚       â”œâ”€â”€ mermaid.min.js     # ä»“åº“é»˜è®¤å†…ç½®çš„ Mermaid v11.12.1
â”‚       â””â”€â”€ mermaid-meta.json  # Mermaid ç‰ˆæœ¬æ¸…å•ï¼ˆæ”¯æŒå¤šç‰ˆæœ¬åˆ‡æ¢ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ download-mermaid.cjs   # ä¸‹è½½æœ€æ–° mermaid çš„è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ proxy.js           # è½»é‡ä»£ç†è§£æä¸ CONNECT å®ç°
â”‚   â””â”€â”€ serve.cjs              # ç®€æ˜“é™æ€æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ README.md
```

## ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TD
  User[ç”¨æˆ·æµè§ˆå™¨] -->|æ‰“å¼€| Index[index.html]
  Index --> App[assets/app.js]
  App --> VersionManifest[ç‰ˆæœ¬æ¸…å•<br/>vendor/mermaid-meta.json]
  App --> VersionSelect[ç‰ˆæœ¬é€‰æ‹©å™¨<br/>versionSelect]
  App --> Loader[åŠ¨æ€è„šæœ¬åŠ è½½å™¨]
  Loader --> Mermaid[Mermaid æ¸²æŸ“å¼•æ“]
  App --> HighlightLayer[è¯­æ³•é«˜äº® & è¡Œå·<br/>highlightLayer + gutter]
  App --> CursorIndicator[å…‰æ ‡è¡Œåˆ—æŒ‡ç¤º<br/>cursorPositionLabel]
  App --> OverlaySync[æ»šåŠ¨/é«˜åº¦åŒæ­¥<br/>syncOverlayMetrics]
  OverlaySync --> HighlightLayer
  OverlaySync --> Gutter[lineNumberGutter]
  CursorIndicator --> FooterMetrics[åº•éƒ¨æŒ‡æ ‡<br/>panel__footer]
  App --> PanZoom[ç¼©æ”¾/å¹³ç§»æ§åˆ¶<br/>previewViewport]
  App --> Examples[assets/examples.js]
  Examples --> Gallery[16 ç±»ç¤ºä¾‹<br/>flowchart/plot/C4...]
  App --> Styles[assets/styles.css]
  Mermaid --> RenderPipeline[æ¸²æŸ“æµç¨‹<br/>mermaid.render]
  RenderPipeline --> Preview[é¢„è§ˆç”»å¸ƒ<br/>preview]
  PanZoom --> Preview
  HighlightLayer --> Editor[ç¼–è¾‘å™¨ textarea]
  RenderPipeline --> Exporters[å¯¼å‡ºä¸å¤åˆ¶æ¨¡å—]
  Exporters --> Clipboard[Clipboard API]
  Exporters --> FileSave[æœ¬åœ°æ–‡ä»¶ä¿å­˜]
  Scripts[Node.js è„šæœ¬] --> Downloader[scripts/download-mermaid.cjs]
  Scripts --> ProxyHelper[scripts/lib/proxy.js]
  Scripts --> DevServer[scripts/serve.cjs]
  Downloader --> VersionManifest
  Downloader --> MermaidBundle[public/vendor/mermaid.min.js]
  DevServer -->|http://localhost:4173| User
```

## æ•°æ®æµå›¾

```mermaid
flowchart LR
  subgraph æµè§ˆå™¨
    VersionManifest[(mermaid-meta.json)] --> LoaderState[åŠ¨æ€åŠ è½½ Mermaid]
    VersionSelect[ç‰ˆæœ¬é€‰æ‹©å™¨] --> LoaderState
    LoaderState -->|æˆåŠŸ| MermaidReady[Mermaid åˆå§‹åŒ–]
    LoaderState -->|å¤±è´¥| ErrorBox[é”™è¯¯æç¤º]
    MermaidReady --> Render[mermaid.render]
    EditorInput[ç¼–è¾‘å™¨è¾“å…¥] --> Highlight[è¯­æ³•é«˜äº® + è¡Œå·]
    Highlight --> EditorScroll[æ»šåŠ¨åŒæ­¥]
    EditorScroll --> OverlaySizer[é«˜åº¦åŒæ­¥]
    EditorInput --> Validate[mermaid.parse æ ¡éªŒ]
    Validate -->|æˆåŠŸ| Render
    Validate -->|å¤±è´¥| ErrorBox
    Render --> Preview[SVG é¢„è§ˆç”»å¸ƒ]
    Preview --> PanZoom[ç¼©æ”¾/å¹³ç§»çŠ¶æ€]
    PanZoom --> Preview
    Render --> SvgExport[å¯¼å‡º SVG]
    Render --> PngPipeline[SVG â†’ PNG]
    Examples[ç¤ºä¾‹åº“é€‰æ‹©] --> EditorInput
    Examples --> GalleryBoard[å›¾è¡¨ç¤ºä¾‹å¡ç‰‡]
    EditorInput --> CursorTracker[å…‰æ ‡ä½ç½®è®¡ç®—]
    CursorTracker --> FooterStats[åº•éƒ¨çŠ¶æ€æ˜¾ç¤º]
    OverlaySizer --> FooterStats
    ThemeToggle[ä¸»é¢˜åˆ‡æ¢] --> MermaidConfig[Mermaid é…ç½®]
    MermaidConfig --> Render
    PngPipeline --> ClipboardPNG[å¤åˆ¶ PNG]
    PngPipeline --> PngDownload[ä¸‹è½½ PNG]
    CopyButton[å¤åˆ¶ä»£ç ] --> ClipboardText[å‰ªè´´æ¿]
  end
  Downloader[download-mermaid.cjs] -->|GitHub Release ä¼˜å…ˆ| Github[mermaid.min.js]
  Downloader -->|CDN å›é€€| CDN[jsDelivr / unpkg]
  Downloader --> ProxyHelper[lib/proxy.js]
  ProxyHelper --> ProxyEnv[HTTPS_PROXY / HTTP_PROXY]
  Github --> MermaidBundle[æ›´æ–°åçš„ mermaid.min.js]
  CDN --> MermaidBundle
  MermaidBundle --> Downloader
  Downloader --> ManifestUpdate[å†™å…¥ mermaid-meta.json]
  ManifestUpdate --> VersionManifest
```

## è°ƒç”¨å›¾

```mermaid
graph TD
  bootstrap --> loadRegistry[loadMermaidRegistry]
  bootstrap --> populateSelect[populateExampleSelect]
  bootstrap --> populateGrid[populateExampleGrid]
  bootstrap --> bind[bindEvents]
  bootstrap --> updateHighlight
  bootstrap --> setInitialExample
  loadRegistry --> populateVersionSelect
  bind --> render[renderDiagram]
  bind --> copy[copyCode]
  bind --> download[downloadSvg]
  bind --> copyPng[copyDiagramImage]
  bind --> downloadPng[downloadPng]
  bind --> applyTheme
  bind --> activate[activateMermaidPackage]
  bind --> updateHighlight
  bind --> syncScroll[syncScrollPosition]
  bind --> cursorEvents[handleSelectionChange]
  activate --> loadScript[loadMermaidScript]
  activate --> initialize[initializeMermaid]
  activate --> render
  initialize --> updateVersionLabel
  render --> resetView
  render --> setStatus[setStatusMessage]
  resetView --> applyPanZoom
  zoom[zoomBy] --> applyPanZoom
  applyTheme --> render
  updateHighlight --> buildHighlight[buildHighlightedHtml]
  updateHighlight --> updateLines[updateLineDecorations]
  updateHighlight --> overlaySync[syncOverlayMetrics]
  updateHighlight --> cursorUpdate[updateCursorPosition]
  updateLines --> calcLines[calculateLineCount]
  updateLines --> overlaySync
  syncScroll --> overlaySync
  cursorEvents --> cursorUpdate
  cursorUpdate --> cursorCalc[calculateCursorPosition]
  overlaySync --> surfaceHeight[getEditorSurfaceHeight]
  copyPng --> svgToPng[svgToPngBlob]
  downloadPng --> svgToPng
  svgToPng --> parseSize[parseSvgDimensions]
  showMessage[showTempMessage] --> setStatus
  render --> showMessage
  download --> showMessage
  copy --> showMessage
  copyPng --> showMessage
  downloadPng --> showMessage
```

## ç”¨æˆ·è§†è§’ç”¨ä¾‹

```mermaid
usecaseDiagram
  actor User
  rectangle LocalMermaid {
    usecase UC1 as "é€‰æ‹©é¢„ç½®ç¤ºä¾‹"
    usecase UC2 as "ç¼–è¾‘å¹¶æ¸²æŸ“ Mermaid å›¾"
    usecase UC3 as "æŸ¥çœ‹æ¸²æŸ“é”™è¯¯æç¤º"
    usecase UC4 as "å¤åˆ¶å½“å‰ä»£ç "
    usecase UC5 as "å¯¼å‡º SVG æ–‡ä»¶"
    usecase UC6 as "åˆ‡æ¢æµ…è‰²/æ·±è‰²ä¸»é¢˜"
    usecase UC7 as "å¤åˆ¶æ¸²æŸ“ PNG"
    usecase UC8 as "ä¸‹è½½ PNG å›¾åƒ"
    usecase UC9 as "åˆ‡æ¢ Mermaid ç‰ˆæœ¬"
    usecase UC10 as "ç¼©æ”¾/å¹³ç§»é¢„è§ˆå›¾"
    usecase UC11 as "æŸ¥çœ‹è¡Œå·ä¸è¡Œæ•°"
    usecase UC12 as "æŸ¥çœ‹å…‰æ ‡æ‰€åœ¨è¡Œåˆ—"
    usecase UC13 as "æµè§ˆå¤šç±»å‹ç¤ºä¾‹"
  }
  User --> UC1
  User --> UC2
  User --> UC3
  User --> UC4
  User --> UC5
  User --> UC6
  User --> UC7
  User --> UC8
  User --> UC9
  User --> UC10
  User --> UC11
  User --> UC12
  User --> UC13
```

## è®¸å¯è¯

MIT
